name: Build Packages (IPK + APK)

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: OpenWrt 23.05 (ipk)
            container: openwrt/sdk:x86-64-23.05.5
            pkg_ext: ipk
          - name: OpenWrt 24.10 (apk)
            container: openwrt/sdk:x86-64-24.10.0
            pkg_ext: apk

    container:
      image: ${{ matrix.container }}
      options: --user 0:0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="1.0.0-$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build package
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          PKG_NAME="luci-theme-proton2025"

          mkdir -p /builder
          cd /builder

          [ -d ./scripts ] || ./setup.sh

          ./scripts/feeds update luci
          ./scripts/feeds install luci-base || true

          rm -rf "package/${PKG_NAME}"
          mkdir -p package
          cp -a "${GITHUB_WORKSPACE}" "package/${PKG_NAME}"

          make defconfig
          make "package/${PKG_NAME}/clean"
          make "package/${PKG_NAME}/compile" -j"$(nproc)" V=s PKG_VERSION="${VERSION}"

          mkdir -p "${GITHUB_WORKSPACE}/out/${{ matrix.pkg_ext }}"
          find bin/packages -type f -name "${PKG_NAME}_*.${{ matrix.pkg_ext }}" -exec cp -v {} "${GITHUB_WORKSPACE}/out/${{ matrix.pkg_ext }}/" \;

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-proton2025-${{ matrix.pkg_ext }}
          path: out/${{ matrix.pkg_ext }}/*.${{ matrix.pkg_ext }}

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: out/${{ matrix.pkg_ext }}/*.${{ matrix.pkg_ext }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Build Packages (IPK + APK)

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: OpenWrt 23.05 (ipk)
            container: openwrt/sdk:x86-64-23.05.5
            pkg_ext: ipk
          - name: OpenWrt main (apk)
            # 24.10 SDK still produces .ipk (ipkg-build). For .apk you need an APK-based SDK.
            container: openwrt/sdk:x86-64-main
            pkg_ext: apk

    container:
      image: ${{ matrix.container }}
      options: --user 0:0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="1.0.0-$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build package
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          PKG_NAME="luci-theme-proton2025"

          # SDK container has /builder as workdir with setup.sh
          cd /builder

          # Run setup.sh if SDK not yet extracted (newer container approach)
          if [ -f ./setup.sh ] && [ ! -d ./scripts ]; then
            ./setup.sh
          fi

          # Avoid transient 503 errors from git.openwrt.org by using GitHub mirrors.
          if [ -f ./feeds.conf.default ]; then
            sed -i 's|https://git.openwrt.org/openwrt/openwrt.git|https://github.com/openwrt/openwrt.git|g' ./feeds.conf.default
            sed -i 's|https://git.openwrt.org/project/luci.git|https://github.com/openwrt/luci.git|g' ./feeds.conf.default
          fi

          # Update feeds (we only need luci.mk, not to build luci-base)
          for i in 1 2 3 4 5; do
            ./scripts/feeds update luci base && break
            echo "feeds update failed (attempt $i/5), retrying in 10s..."
            sleep 10
          done

          ./scripts/feeds install -p luci luci-base  # Install package definition, not build

          # Copy theme package (exclude .git and .github)
          rm -rf "package/${PKG_NAME}"
          mkdir -p "package/${PKG_NAME}"
          cp -r "${GITHUB_WORKSPACE}/htdocs" "package/${PKG_NAME}/"
          cp -r "${GITHUB_WORKSPACE}/root" "package/${PKG_NAME}/"
          cp -r "${GITHUB_WORKSPACE}/ucode" "package/${PKG_NAME}/"
          cp "${GITHUB_WORKSPACE}/Makefile" "package/${PKG_NAME}/"

          # Set version in the package Makefile (not globally!)
          sed -i "s/^PKG_VERSION.*/PKG_VERSION:=${VERSION}/" "package/${PKG_NAME}/Makefile"

          # Build
          make defconfig
          make "package/${PKG_NAME}/compile" -j"$(nproc)" V=s || \
            make "package/${PKG_NAME}/compile" -j1 V=s

          # Copy result
          mkdir -p "${GITHUB_WORKSPACE}/out/${{ matrix.pkg_ext }}"
          if ! find bin/packages -type f -name "${PKG_NAME}*.${{ matrix.pkg_ext }}" -print -quit | grep -q .; then
            echo "ERROR: Expected a .${{ matrix.pkg_ext }} package, but none was produced."
            echo "This usually means the selected SDK still builds IPK packages."
            echo "Found theme packages:";
            find bin/packages -type f \( -name "${PKG_NAME}*.ipk" -o -name "${PKG_NAME}*.apk" \) -print || true
            exit 1
          fi

          find bin/packages -type f -name "${PKG_NAME}*.${{ matrix.pkg_ext }}" \
            -exec cp -v {} "${GITHUB_WORKSPACE}/out/${{ matrix.pkg_ext }}/" \;

          # Debug: show what was built
          echo "=== Built packages ==="
          find bin/packages -type f \( -name "*.ipk" -o -name "*.apk" \) -ls || true
          ls -la "${GITHUB_WORKSPACE}/out/${{ matrix.pkg_ext }}/" || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-proton2025-${{ matrix.pkg_ext }}
          path: out/${{ matrix.pkg_ext }}/*.${{ matrix.pkg_ext }}

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: out/${{ matrix.pkg_ext }}/*.${{ matrix.pkg_ext }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

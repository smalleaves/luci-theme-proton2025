name: Build IPK & APK Packages

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build LuCI Theme Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="1.0.0-$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare package files
        id: prepare
        run: |
          PKG_NAME="luci-theme-proton2025"

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¾Ð±Ñ‰ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          mkdir -p pkg-data/www/luci-static/proton2025
          mkdir -p pkg-data/www/luci-static/resources
          mkdir -p pkg-data/usr/share/ucode/luci/template/themes/proton2025
          mkdir -p pkg-data/usr/share/rpcd/acl.d
          mkdir -p pkg-data/usr/share/rpcd/ucode
          mkdir -p pkg-data/etc/uci-defaults
          mkdir -p pkg-data/etc/config

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ‚ÐµÐ¼Ñ‹
          cp -r htdocs/luci-static/proton2025/* pkg-data/www/luci-static/proton2025/
          cp -r ucode/template/themes/proton2025/* pkg-data/usr/share/ucode/luci/template/themes/proton2025/
          cp root/etc/uci-defaults/30_luci-theme-proton2025 pkg-data/etc/uci-defaults/

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³
          if [ -f "root/etc/config/proton2025" ]; then
            cp root/etc/config/proton2025 pkg-data/etc/config/
          fi

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ RPC Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð¸ ACL
          if [ -f "root/usr/share/rpcd/ucode/luci.proton-temp" ]; then
            cp root/usr/share/rpcd/ucode/luci.proton-temp pkg-data/usr/share/rpcd/ucode/
          fi
          if [ -f "root/usr/share/rpcd/ucode/luci.proton-settings" ]; then
            cp root/usr/share/rpcd/ucode/luci.proton-settings pkg-data/usr/share/rpcd/ucode/
          fi
          if [ -f "root/usr/share/rpcd/acl.d/luci-theme-proton2025.json" ]; then
            cp root/usr/share/rpcd/acl.d/luci-theme-proton2025.json pkg-data/usr/share/rpcd/acl.d/
          fi

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ JS Ð¼ÐµÐ½ÑŽ
          if [ -d "htdocs/luci-static/resources" ]; then
            cp -r htdocs/luci-static/resources/* pkg-data/www/luci-static/resources/ 2>/dev/null || true
          fi

          # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€
          INSTALLED_SIZE=$(du -sb pkg-data | cut -f1)
          echo "size=$INSTALLED_SIZE" >> $GITHUB_OUTPUT

      - name: Build IPK (for OpenWrt with opkg)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG_NAME="luci-theme-proton2025"
          INSTALLED_SIZE="${{ steps.prepare.outputs.size }}"

          mkdir -p ipk-build/control
          mkdir -p ipk-build/data
          cp -r pkg-data/* ipk-build/data/

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ control Ñ„Ð°Ð¹Ð»
          cat > ipk-build/control/control << 'CONTROL_END'
          Package: luci-theme-proton2025
          Depends: libc, luci-base
          License: Apache-2.0
          Section: luci
          Architecture: all
          Description: Proton2025 - Elegant Dark Theme for LuCI
          CONTROL_END
          sed -i 's/^[[:space:]]*//' ipk-build/control/control
          sed -i "1s/.*/Package: ${PKG_NAME}/" ipk-build/control/control
          sed -i "2i Version: ${VERSION}" ipk-build/control/control
          sed -i "4i Source: https://github.com/${{ github.repository }}" ipk-build/control/control
          sed -i "5i SourceName: ${PKG_NAME}" ipk-build/control/control
          sed -i "/Architecture/a Installed-Size: ${INSTALLED_SIZE}" ipk-build/control/control

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ postinst ÑÐºÑ€Ð¸Ð¿Ñ‚
          cat > ipk-build/control/postinst << 'POSTINST_END'
          #!/bin/sh
          [ -n "${IPKG_INSTROOT}" ] || {
            uci -q set luci.themes.Proton2025=/luci-static/proton2025
            uci -q commit luci
            /etc/init.d/rpcd restart 2>/dev/null || true
          }
          exit 0
          POSTINST_END
          sed -i 's/^[[:space:]]*//' ipk-build/control/postinst
          chmod 755 ipk-build/control/postinst

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ prerm ÑÐºÑ€Ð¸Ð¿Ñ‚
          cat > ipk-build/control/prerm << 'PRERM_END'
          #!/bin/sh
          [ -n "${IPKG_INSTROOT}" ] || {
            uci -q delete luci.themes.Proton2025
            uci -q commit luci
          }
          exit 0
          PRERM_END
          sed -i 's/^[[:space:]]*//' ipk-build/control/prerm
          chmod 755 ipk-build/control/prerm

          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ IPK
          cd ipk-build/control && tar czvf ../control.tar.gz . && cd ../..
          cd ipk-build/data && tar czvf ../data.tar.gz . && cd ../..
          echo "2.0" > ipk-build/debian-binary
          cd ipk-build && tar czvf "../${PKG_NAME}_${VERSION}_all.ipk" ./debian-binary ./control.tar.gz ./data.tar.gz && cd ..

          echo "Built IPK: ${PKG_NAME}_${VERSION}_all.ipk"
          ls -la *.ipk

      - name: Build APK (for OpenWrt 24.10+ with apk)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG_NAME="luci-theme-proton2025"
          INSTALLED_SIZE="${{ steps.prepare.outputs.size }}"

          mkdir -p apk-build
          cp -r pkg-data/* apk-build/

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .PKGINFO (Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ APK Ð¿Ð°ÐºÐµÑ‚Ð°)
          cat > apk-build/.PKGINFO << PKGINFO_END
          pkgname = ${PKG_NAME}
          pkgver = ${VERSION}-r1
          pkgdesc = Proton2025 - Elegant Dark Theme for LuCI
          url = https://github.com/${{ github.repository }}
          size = ${INSTALLED_SIZE}
          arch = noarch
          license = Apache-2.0
          origin = ${PKG_NAME}
          depend = luci-base
          PKGINFO_END
          sed -i 's/^[[:space:]]*//' apk-build/.PKGINFO

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .post-install ÑÐºÑ€Ð¸Ð¿Ñ‚
          cat > apk-build/.post-install << 'POSTINSTALL_END'
          #!/bin/sh
          uci -q set luci.themes.Proton2025=/luci-static/proton2025
          uci -q commit luci
          /etc/init.d/rpcd restart 2>/dev/null || true
          exit 0
          POSTINSTALL_END
          sed -i 's/^[[:space:]]*//' apk-build/.post-install
          chmod 755 apk-build/.post-install

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .pre-deinstall ÑÐºÑ€Ð¸Ð¿Ñ‚
          cat > apk-build/.pre-deinstall << 'PREDEINSTALL_END'
          #!/bin/sh
          uci -q delete luci.themes.Proton2025
          uci -q commit luci
          exit 0
          PREDEINSTALL_END
          sed -i 's/^[[:space:]]*//' apk-build/.pre-deinstall
          chmod 755 apk-build/.pre-deinstall

          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ APK (Alpine Package format)
          cd apk-build
          # APK Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ gzip Ð±ÐµÐ· verbose
          tar --sort=name --owner=0 --group=0 --mtime='1970-01-01' -czf "../${PKG_NAME}_${VERSION}_all.apk" .PKGINFO .post-install .pre-deinstall www usr etc
          cd ..

          echo "Built APK: ${PKG_NAME}_${VERSION}_all.apk"
          ls -la *.apk

      - name: Upload IPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-proton2025-ipk
          path: "*.ipk"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-proton2025-apk
          path: "*.apk"

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.ipk
            *.apk
          body: |
            ## Proton2025 Theme v${{ steps.version.outputs.version }}

            ### ðŸ“¦ Packages
            - **`.ipk`** â€” Ð´Ð»Ñ OpenWrt Ñ opkg (Ð²ÐµÑ€ÑÐ¸Ð¸ Ð´Ð¾ 24.x)
            - **`.apk`** â€” Ð´Ð»Ñ OpenWrt Ñ apk (Ð²ÐµÑ€ÑÐ¸Ð¸ 24.10+)

            ### ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°

            **opkg (IPK):**
            ```bash
            opkg install luci-theme-proton2025_*.ipk
            ```

            **apk (APK):**
            ```bash
            apk add --allow-untrusted luci-theme-proton2025_*.apk
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

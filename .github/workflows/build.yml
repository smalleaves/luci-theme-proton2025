name: Build IPK & APK Packages

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build LuCI Theme Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="1.0.0-$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare package files
        id: prepare
        run: |
          PKG_NAME="luci-theme-proton2025"
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¾Ð±Ñ‰ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          mkdir -p pkg-data/www/luci-static/proton2025
          mkdir -p pkg-data/www/luci-static/resources
          mkdir -p pkg-data/usr/share/ucode/luci/template/themes/proton2025
          mkdir -p pkg-data/usr/share/rpcd/acl.d
          mkdir -p pkg-data/usr/share/rpcd/ucode
          mkdir -p pkg-data/etc/uci-defaults
          mkdir -p pkg-data/etc/config

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ‚ÐµÐ¼Ñ‹
          cp -r htdocs/luci-static/proton2025/* pkg-data/www/luci-static/proton2025/
          cp -r ucode/template/themes/proton2025/* pkg-data/usr/share/ucode/luci/template/themes/proton2025/
          cp root/etc/uci-defaults/30_luci-theme-proton2025 pkg-data/etc/uci-defaults/

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³
          if [ -f "root/etc/config/proton2025" ]; then
            cp root/etc/config/proton2025 pkg-data/etc/config/
          fi

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ RPC Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð¸ ACL
          if [ -f "root/usr/share/rpcd/ucode/luci.proton-temp" ]; then
            cp root/usr/share/rpcd/ucode/luci.proton-temp pkg-data/usr/share/rpcd/ucode/
          fi
          if [ -f "root/usr/share/rpcd/ucode/luci.proton-settings" ]; then
            cp root/usr/share/rpcd/ucode/luci.proton-settings pkg-data/usr/share/rpcd/ucode/
          fi
          if [ -f "root/usr/share/rpcd/acl.d/luci-theme-proton2025.json" ]; then
            cp root/usr/share/rpcd/acl.d/luci-theme-proton2025.json pkg-data/usr/share/rpcd/acl.d/
          fi

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ JS Ð¼ÐµÐ½ÑŽ
          if [ -d "htdocs/luci-static/resources" ]; then
            cp -r htdocs/luci-static/resources/* pkg-data/www/luci-static/resources/ 2>/dev/null || true
          fi

          # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€
          INSTALLED_SIZE=$(du -sb pkg-data | cut -f1)
          echo "size=$INSTALLED_SIZE" >> $GITHUB_OUTPUT

      - name: Build IPK (for OpenWrt with opkg)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG_NAME="luci-theme-proton2025"
          INSTALLED_SIZE="${{ steps.prepare.outputs.size }}"

          mkdir -p ipk-build/control
          cp -r pkg-data ipk-build/data

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ control Ñ„Ð°Ð¹Ð» (Ð±ÐµÐ· Ð»Ð¸ÑˆÐ½Ð¸Ñ… Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð²)
          cat > ipk-build/control/control << EOF
Package: ${PKG_NAME}
Version: ${VERSION}
Depends: libc, luci-base
Source: https://github.com/${{ github.repository }}
SourceName: ${PKG_NAME}
License: Apache-2.0
Section: luci
Architecture: all
Installed-Size: ${INSTALLED_SIZE}
Description: Proton2025 - Elegant Dark Theme for LuCI
EOF

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ postinst ÑÐºÑ€Ð¸Ð¿Ñ‚
          cat > ipk-build/control/postinst << 'EOF'
#!/bin/sh
[ -n "${IPKG_INSTROOT}" ] || {
  uci -q batch <<-EOI
    set luci.themes.Proton2025=/luci-static/proton2025
    commit luci
EOI
  /etc/init.d/rpcd restart 2>/dev/null || true
}
exit 0
EOF
          chmod 755 ipk-build/control/postinst

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ prerm ÑÐºÑ€Ð¸Ð¿Ñ‚
          cat > ipk-build/control/prerm << 'EOF'
#!/bin/sh
[ -n "${IPKG_INSTROOT}" ] || {
  uci -q delete luci.themes.Proton2025
  uci commit luci
}
exit 0
EOF
          chmod 755 ipk-build/control/prerm

          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ IPK
          cd ipk-build/control && tar czvf ../control.tar.gz . && cd ../..
          cd ipk-build/data && tar czvf ../data.tar.gz . && cd ../..
          echo "2.0" > ipk-build/debian-binary
          cd ipk-build && tar czvf "../${PKG_NAME}_${VERSION}_all.ipk" ./debian-binary ./control.tar.gz ./data.tar.gz && cd ..

          echo "Built IPK: ${PKG_NAME}_${VERSION}_all.ipk"
          ls -la *.ipk

      - name: Build APK (for OpenWrt 24.10+ with apk)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG_NAME="luci-theme-proton2025"
          INSTALLED_SIZE="${{ steps.prepare.outputs.size }}"

          mkdir -p apk-build
          cp -r pkg-data/* apk-build/

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .PKGINFO (Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ APK Ð¿Ð°ÐºÐµÑ‚Ð°)
          # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹ Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÑÑ‚Ñ€Ð¾Ðº ÑÑ€Ð°Ð·Ñƒ
          cat > apk-build/.PKGINFO << EOF
pkgname = ${PKG_NAME}
pkgver = ${VERSION}-r1
pkgdesc = Proton2025 - Elegant Dark Theme for LuCI
url = https://github.com/${{ github.repository }}
size = ${INSTALLED_SIZE}
arch = noarch
license = Apache-2.0
origin = ${PKG_NAME}
depend = luci-base
EOF

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .post-install ÑÐºÑ€Ð¸Ð¿Ñ‚
          cat > apk-build/.post-install << 'EOF'
#!/bin/sh
uci -q batch <<-EOI
  set luci.themes.Proton2025=/luci-static/proton2025
  commit luci
EOI
/etc/init.d/rpcd restart 2>/dev/null || true
exit 0
EOF
          chmod 755 apk-build/.post-install

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .pre-deinstall ÑÐºÑ€Ð¸Ð¿Ñ‚
          cat > apk-build/.pre-deinstall << 'EOF'
#!/bin/sh
uci -q delete luci.themes.Proton2025
uci commit luci
exit 0
EOF
          chmod 755 apk-build/.pre-deinstall

          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ APK (tar.gz Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½Ð½Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹)
          # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð², Ð·Ð°Ñ‚ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼
          cd apk-build
          # ÐÑ€Ñ…Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼: ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ, Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
          tar czvf "../${PKG_NAME}_${VERSION}_all.apk" \
            .PKGINFO \
            .post-install \
            .pre-deinstall \
            www \
            usr \
            etc
          cd ..

          echo "Built APK: ${PKG_NAME}_${VERSION}_all.apk"
          ls -la *.apk

      - name: Upload IPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-proton2025-ipk
          path: "*.ipk"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-proton2025-apk
          path: "*.apk"

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.ipk
            *.apk
          body: |
            ## Proton2025 Theme v${{ steps.version.outputs.version }}
            
            ### ðŸ“¦ Packages
            - **`.ipk`** â€” Ð´Ð»Ñ OpenWrt Ñ opkg (Ð²ÐµÑ€ÑÐ¸Ð¸ Ð´Ð¾ 24.x)
            - **`.apk`** â€” Ð´Ð»Ñ OpenWrt Ñ apk (Ð²ÐµÑ€ÑÐ¸Ð¸ 24.10+)
            
            ### ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
            
            **opkg (IPK):**
            ```bash
            opkg install luci-theme-proton2025_*.ipk
            ```
            
            **apk (APK):**
            ```bash
            apk add --allow-untrusted luci-theme-proton2025_*.apk
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
